---
layout: post
status: publish
published: true
title: 使用cffi和re2实现部分Python内置re模块功能(兼容pypy)
author:
  display_name: admin
  login: admin
  email: nobody@gmail.com
  url: ''
author_login: admin
author_email: nobody@gmail.com
wordpress_id: 40358
wordpress_url: http://blog.lzhaohao.info/?p=40358
date: '2013-11-19 11:32:45 +0000'
date_gmt: '2013-11-19 03:32:45 +0000'
categories:
- python
tags:
- python
- pypy
- re2
- cffi
comments: []
---
<p>从一些<a href="http://lh3lh3.users.sourceforge.net/reb.shtml">benchmark</a>可以看出，Python内置的re模块比起re2是慢很多的。而Google的re2(<a href="https://code.google.com/p/re2/">https://code.google.com/p/re2/</a>)是一个速度快的C++正则库。是否可以在Python内利用re2呢？有一些人已经做了相关的工作：<a href="https://github.com/facebook/pyre2/" title="https://github.com/facebook/pyre2/">facebook/pyre2</a> <a href="https://github.com/axiak/pyre2" title="https://github.com/axiak/pyre2">axiak/pyre2</a>，但这些都是采用CPython扩展/Cython的方式编写，在pypy下不能正常使用。如何既能得到pypy的速度，也能利用re2？首先想到了CPython和pypy都内置的ctypes模块，可以用来访问C编写的so库。</p>
<p>但从实际测试结果来看，在pypy下使用ctypes是比较慢的，有人也报了BUG(<a href="https://bugs.pypy.org/issue1237" title="https://bugs.pypy.org/issue1237">https://bugs.pypy.org/issue1237</a>)，但仍未解决。测试数据如下：<br />
<iframe width="700" height="380" frameborder="0" scrolling="no" src="https://skydrive.live.com/embed?cid=95937A385843A3BA&resid=95937A385843A3BA%21242&authkey=AJMjoSNd8ldblfE&em=2&wdAllowInteractivity=False&Item='Sheet1'!A1%3AL9&wdHideGridlines=True&wdDownloadButton=True"></iframe></p>
<p>还有另外一个第三方库:cffi(<a href="http://cffi.readthedocs.org/">http://cffi.readthedocs.org/</a>)，可以实现类似ctypes的访问C库并调用其函数的功能。跟ctypes一样，cffi也只能访问C的so，无法直接访问C++的so，因此我们要为re2包装一层，暴露C接口。具体代码在<a href="https://github.com/vls/cffi_re2" title="https://github.com/vls/cffi_re2">github</a>。从上面的测试可以看出，cffi_re2在某些正则下是原生re模块的速度的50倍，但有些正则却会比原生的慢&hellip;&hellip;</p>
<p>使用了我们生产的真实数据和真实正则测试，测试代码：<a href="https://gist.github.com/vls/7539716">https://gist.github.com/vls/7539716</a>(涉及公司数据，这里无法给出测试数据)，在CPython和pypy下都能取得一些性能上的提升：）<br />
<iframe width="373" height="202" frameborder="0" scrolling="no" src="https://skydrive.live.com/embed?cid=95937A385843A3BA&resid=95937A385843A3BA%21252&authkey=AEEaHJAYfm7O9OA&em=2&wdAllowInteractivity=False&Item='%E5%B7%A5%E4%BD%9C%E8%A1%A81'!A1%3AC8&wdHideGridlines=True&wdDownloadButton=True"></iframe></p>
